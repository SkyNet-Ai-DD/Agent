# Этап 2: Разработка и настройка workflow в n8n

## Общая архитектура workflows

Архитектура workflows в n8n основана на концепции модульности и специализации. Каждый workflow решает определенную задачу или класс задач, что позволяет эффективно масштабировать систему и поддерживать ее.

### Основные принципы:
1. **Модульность**: Каждый workflow выполняет одну основную функцию
2. **Композиция**: Сложные задачи решаются комбинацией простых workflows
3. **Переиспользуемость**: Общие компоненты могут использоваться в разных workflows
4. **Масштабируемость**: Возможность горизонтального масштабирования
5. **Отказоустойчивость**: Обработка ошибок и fallback-механизмы

## Базовый workflow обработки запроса

Базовый workflow является центральным элементом архитектуры мета-агента. Он принимает запросы от пользователей и направляет их в соответствующие специализированные workflows.

### Структура базового workflow:

1. **Триггер**:
   - Нода Telegram Trigger, Webhook или Chat Trigger
   - Прием сообщений от пользователей
   - Извлечение текста запроса и метаданных

2. **Предварительная обработка**:
   - Нода Function для очистки и нормализации запроса
   - Извлечение идентификатора пользователя
   - Загрузка контекста диалога из базы данных

3. **Классификация запроса**:
   - Нода AI Agent с промптом-классификатором
   - Определение типа запроса (технический вопрос, запрос на чертеж, поиск стандарта и т.д.)
   - Генерация метки (label) для маршрутизации

4. **Маршрутизация**:
   - Нода Switch или IF для направления запроса
   - Передача управления соответствующему специальному workflow
   - Передача контекста и параметров запроса

5. **Обработка результата**:
   - Прием результата от специализированного workflow
   - Форматирование ответа для пользователя
   - Отправка результата через соответствующий канал

6. **Обновление контекста**:
   - Сохранение результата и контекста в базе данных
   - Подготовка к следующему запросу

### Пример структуры базового workflow:
```
[Telegram Trigger] -> [Function: Предобработка] -> [AI Agent: Классификация] 
     -> [Switch: Маршрутизация] -> [Специализированный Workflow] 
     -> [Function: Форматирование ответа] -> [Telegram: Отправка ответа]
     -> [Function: Обновление контекста]
```

## Workflow для ответов на технические вопросы

Этот workflow предназначен для обработки запросов, требующих технических знаний и поиска информации в базах знаний.

### Структура workflow:

1. **Векторный поиск**:
   - Нода Function или HTTP Request для выполнения запроса к векторной БД
   - Поиск релевантных фрагментов из ГОСТов, мануалов и технической базы знаний
   - Получение snippets с информацией, релевантной запросу пользователя

2. **Формирование контекста**:
   - Нода Function (на JavaScript) для форматирования найденных snippets
   - Комбинирование найденной информации с историей диалога
   - Подготовка структурированного контекста для LLM

3. **Генерация ответа**:
   - Нода AI Agent с мощным промпт-шаблоном
   - Реализация RAG (Retrieval Augmented Generation)
   - Генерация ответа на основе предоставленной документации

4. **Возможность веб-поиска**:
   - Нода HTTP Request к API поисковых систем (Brave Search, Google Custom Search)
   - Поиск самой свежей информации в интернете
   - Интеграция результатов веб-поиска в контекст для LLM

5. **Отправка результата**:
   - Нода Telegram, Email или другой канал вывода
   - Отправка сгенерированного ответа пользователю

### Пример структуры workflow:
```
[Вход от базового workflow] -> [Function: Векторный поиск] 
     -> [Function: Формирование контекста] -> [AI Agent: Генерация ответа]
     -> [HTTP Request: Веб-поиск (опционально)] 
     -> [Function: Интеграция результатов] -> [AI Agent: Финальная генерация]
     -> [Канал вывода: Отправка ответа]
```

## Workflow для работы с конструкторской документацией

Этот workflow обрабатывает запросы, связанные с созданием конструкторской документации, спецификаций и чертежей.

### Структура workflow:

1. **Извлечение параметров**:
   - Нода AI Agent с промптом для извлечения сущностей
   - Извлечение структурированных данных из запроса пользователя
   - Формирование JSON-объекта с параметрами

2. **Поиск стандартов**:
   - Нода PostgreSQL, Google Sheets или HTTP Request
   - Запрос к базе данных ГОСТов по извлеченным параметрам
   - Получение точных номеров стандартов на посадки, шероховатости и т.д.

3. **Генерация спецификации**:
   - Нода Function или AI Agent для формирования текстового содержимого
   - Создание спецификации в формате Markdown или HTML
   - Интеграция информации из стандартов

4. **Конвертация в PDF**:
   - Нода PDF для конвертации сгенерированного текста в PDF-файл
   - Настройка параметров форматирования и стиля
   - Генерация финального PDF-документа

5. **Создание чертежа**:
   - Вариант 1 (Простой): Генерация текстового технического задания
   - Вариант 2 (Автоматизированный): Формирование скрипта для САПР или JSON-запроса к API
   - Нода HTTP Request для отправки команды в AutoCAD или SolidWorks
   - Получение пути к готовому файлу чертежа

6. **Сохранение и отправка**:
   - Ноды Google Drive или Nextcloud для сохранения файлов
   - Нода Telegram, Email или Slack для отправки результатов пользователю
   - Отправка ссылок на файлы или самих файлов

### Пример структуры workflow:
```
[Вход от базового workflow] -> [AI Agent: Извлечение параметров]
     -> [HTTP Request: Поиск стандартов] -> [Function: Генерация спецификации]
     -> [PDF: Конвертация в PDF] -> [Function: Создание чертежа]
     -> [HTTP Request: Отправка в САПР] -> [Google Drive: Сохранение файлов]
     -> [Канал вывода: Отправка результатов]
```

## Реализация памяти и контекста

Для обеспечения связности диалога и персонализации взаимодействия необходимо реализовать систему памяти и контекста.

### Временная память:
1. **Simple Memory нода**:
   - Использование встроенной ноды Simple Memory в AI Agent
   - Хранение контекста диалога в рамках одной сессии
   - Автоматическое обновление памяти после каждого сообщения

### Долговременная память:
1. **База данных**:
   - Использование PostgreSQL или SQLite для хранения истории взаимодействий
   - Нода AI Agent сконфигурирована для записи и чтения истории из БД
   - Ассоциация контекста с идентификатором пользователя

2. **Структура хранения**:
   - Идентификатор пользователя
   - История сообщений (входящие и исходящие)
   - Метаданные (время, канал, тип запроса)
   - Контекстуальная информация (предпочтения, проекты)

### Управление контекстом:
1. **Загрузка контекста**:
   - При начале диалога загрузка истории из базы данных
   - Формирование полного контекста для LLM

2. **Обновление контекста**:
   - После каждого запроса обновление истории в базе данных
   - Сохранение результатов и метаданных

3. **Сброс контекста**:
   - Возможность принудительного сброса контекста по команде пользователя
   - Автоматический сброс по истечении времени неактивности

## Обработка ошибок и исключительных ситуаций

Для обеспечения надежности работы workflows необходимо реализовать систему обработки ошибок.

### Типы ошибок:
1. **Сетевые ошибки**: Таймауты, недоступность внешних сервисов
2. **Ошибки данных**: Некорректные входные данные, проблемы с парсингом
3. **Ошибки выполнения**: Исключения в нодах, проблемы с API
4. **Бизнес-ошибки**: Невозможность выполнить запрос по логическим причинам

### Подходы к обработке:
1. **Retry-логика**:
   - Реализация повторных попыток для временных ошибок
   - Настройка экспоненциальной задержки между попытками
   - Ограничение максимального количества попыток

2. **Fallback-механизмы**:
   - Альтернативные пути выполнения при ошибках
   - Уведомление пользователя о проблемах
   - Предоставление альтернативных решений

3. **Логирование и мониторинг**:
   - Запись всех ошибок в лог
   - Уведомление администраторов о критических ошибках
   - Сбор метрик для анализа и улучшения

## Конфигурация и параметризация

Для обеспечения гибкости и возможности настройки workflows необходимо реализовать систему конфигурации.

### Источники конфигурации:
1. **Environment Variables**:
   - Хранение API ключей, токенов и других секретов
   - Настройка параметров подключения к внешним сервисам

2. **Configuration Files**:
   - JSON или YAML файлы с настройками workflows
   - Возможность хранения сложных конфигураций

3. **Database Configuration**:
   - Хранение динамических настроек в базе данных
   - Возможность изменения настроек без перезапуска

### Параметризация workflows:
1. **Динамические параметры**:
   - Использование переменных в нодах
   - Возможность изменения поведения без изменения структуры workflow

2. **Условная логика**:
   - Ноды Switch и IF для реализации условного выполнения
   - Возможность включения/выключения функций

## Тестирование и отладка

Для обеспечения качества и надежности workflows необходимо реализовать систему тестирования.

### Unit-тестирование:
1. **Тестирование отдельных нод**:
   - Проверка корректности работы каждой ноды
   - Тестирование различных сценариев входных данных

2. **Mock-объекты**:
   - Использование mock-нод для имитации внешних сервисов
   - Тестирование без реальных зависимостей

### Интеграционное тестирование:
1. **Тестирование workflows целиком**:
   - Проверка корректности взаимодействия между нодами
   - Тестирование полного цикла обработки запроса

2. **Тестовые данные**:
   - Подготовка набора тестовых запросов
   - Проверка корректности результатов

### Отладка:
1. **Логирование**:
   - Детальное логирование выполнения workflows
   - Возможность трассировки выполнения

2. **Инструменты отладки n8n**:
   - Использование встроенных инструментов для анализа выполнения
   - Просмотр промежуточных результатов

## Масштабирование и производительность

Для обеспечения высокой производительности и возможности масштабирования необходимо учитывать следующие аспекты:

### Горизонтальное масштабирование:
1. **Кластеризация**:
   - Настройка кластера n8n для распределения нагрузки
   - Синхронизация состояния между инстансами

2. **Балансировка нагрузки**:
   - Использование load balancer для распределения запросов
   - Разделение workflows по разным серверам

### Оптимизация производительности:
1. **Кэширование**:
   - Кэширование часто запрашиваемых данных
   - Использование Redis или других систем кэширования

2. **Параллельная обработка**:
   - Использование параллельных ветвей выполнения
   - Асинхронная обработка независимых операций

3. **Оптимизация запросов**:
   - Минимизация количества обращений к внешним сервисам
   - Использование batch-запросов при возможности

## Безопасность

Для обеспечения безопасности работы workflows необходимо учитывать следующие аспекты:

### Аутентификация и авторизация:
1. **Защита API**:
   - Использование API ключей и токенов
   - Реализация OAuth 2.0 для внешних сервисов

2. **Контроль доступа**:
   - Ограничение доступа к workflows по ролям
   - Аудит действий пользователей

### Шифрование данных:
1. **Передача данных**:
   - Использование HTTPS для всех внешних запросов
   - Шифрование чувствительных данных в базе знаний

2. **Хранение секретов**:
   - Использование защищенного хранилища для API ключей
   - Регулярная ротация секретов

## Мониторинг и логирование

Для обеспечения наблюдаемости и возможности оперативного реагирования на проблемы необходимо реализовать систему мониторинга.

### Логирование:
1. **Структурированные логи**:
   - Запись всех событий в структурированном формате
   - Возможность фильтрации и поиска по логам

2. **Уровни логирования**:
   - Различные уровни детализации (debug, info, warn, error)
   - Настройка уровня логирования для разных компонентов

### Метрики:
1. **Производительность**:
   - Время выполнения workflows
   - Количество обработанных запросов
   - Использование ресурсов

2. **Ошибки**:
   - Статистика по типам ошибок
   - Частота возникновения проблем
   - Время восстановления после ошибок

### Алертинг:
1. **Уведомления**:
   - Отправка уведомлений о критических ошибках
   - Алерты о превышении пороговых значений метрик

2. **Интеграция с системами мониторинга**:
   - Интеграция с Prometheus, Grafana и другими системами
   - Возможность централизованного мониторинга
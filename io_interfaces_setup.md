# Настройка интерфейсов ввода/вывода

## Ввод

Мета-агент должен поддерживать различные каналы ввода для максимального удобства пользователей. Ниже описаны основные интерфейсы ввода и их настройка.

### 1. Telegram Bot

#### Настройка Telegram бота:
1. **Создание бота**:
   - Открыть Telegram и найти @BotFather
   - Отправить команду `/newbot`
   - Следовать инструкциям для создания нового бота
   - Получить API токен бота

2. **Конфигурация в n8n**:
   - Добавить ноду "Telegram Trigger"
   - Ввести API токен бота
   - Настроить webhook URL (если используется self-hosted n8n)
   - Определить типы сообщений для обработки (текст, документы, изображения)

3. **Обработка сообщений**:
   - Настройка фильтрации сообщений по типу
   - Обработка команд и текстовых сообщений
   - Прием файлов и изображений от пользователей
   - Реализация контекста диалога

#### Пример конфигурации ноды Telegram Trigger:
```json
{
  "authentication": "botToken",
  "botToken": "{{telegram_bot_token}}",
  "updates": ["message", "edited_message"],
  "options": {
    "includeMedia": true,
    "includeDocuments": true
  }
}
```

### 2. Встроенный веб-чат n8n

#### Настройка встроенного чата:
1. **Активация чата**:
   - Включить опцию "Enable Chat" в настройках n8n
   - Настроить доступ к чату (публичный/приватный)
   - Настроить аутентификацию пользователей

2. **Кастомизация интерфейса**:
   - Настройка приветственного сообщения
   - Определение доступных команд
   - Настройка внешнего вида чата

3. **Интеграция с workflow**:
   - Использование ноды "Chat Trigger" для получения сообщений
   - Обработка сообщений аналогично Telegram
   - Поддержка rich-контента (кнопки, карточки)

### 3. Webhook

#### Настройка webhook-интерфейса:
1. **Создание webhook endpoint**:
   - Определение URL для приема webhook-запросов
   - Настройка аутентификации (API ключи, OAuth)
   - Определение формата данных запроса

2. **Обработка запросов**:
   - Валидация входящих запросов
   - Парсинг данных из тела запроса
   - Обработка различных методов HTTP (GET, POST)

3. **Интеграция с внешними системами**:
   - Прием запросов от веб-приложений
   - Интеграция с корпоративными системами
   - Поддержка REST API

#### Пример конфигурации webhook:
```json
{
  "method": "POST",
  "path": "/api/meta-agent",
  "headers": {
    "Content-Type": "application/json",
    "Authorization": "Bearer {{api_key}}"
  },
 "body": {
    "user_id": "{{user_id}}",
    "query": "{{user_query}}",
    "context": "{{conversation_context}}"
  }
}
```

### 4. Формы

#### Создание web-форм:
1. **Дизайн форм**:
   - Определение полей формы (текст, числа, выбор из списка)
   - Настройка валидации полей
   - Добавление описаний и подсказок

2. **Интеграция с n8n**:
   - Использование ноды "Webhook" для приема данных формы
   - Обработка данных формы в workflow
   - Валидация и очистка данных

3. **Пример формы для запроса чертежа**:
   - Поле "Название детали" (текст)
   - Поле "Материал" (выбор из списка)
   - Поле "Размеры" (числа)
   - Поле "Дополнительные требования" (текстовое поле)

## Вывод

Мета-агент должен поддерживать различные каналы вывода результатов для обеспечения удобства пользователей.

### 1. Отправка через Telegram

#### Настройка отправки сообщений:
1. **Конфигурация ноды Telegram**:
   - Использование ноды "Telegram" для отправки сообщений
   - Настройка форматирования сообщений (Markdown, HTML)
   - Отправка текстовых сообщений и документов

2. **Отправка файлов**:
   - Отправка PDF-файлов спецификаций
   - Отправка чертежей в различных форматах
   - Отправка изображений и диаграмм

#### Пример конфигурации ноды Telegram для отправки:
```json
{
  "authentication": "botToken",
  "botToken": "{{telegram_bot_token}}",
  "chatId": "{{user_chat_id}}",
  "text": "{{response_text}}",
  "additionalFields": {
    "parse_mode": "Markdown",
    "disable_web_page_preview": true
  }
}
```

### 2. Сохранение в Google Drive

#### Настройка интеграции с Google Drive:
1. **Аутентификация**:
   - Настройка OAuth 2.0 приложения Google
   - Получение учетных данных (Client ID, Client Secret)
   - Настройка прав доступа к Google Drive

2. **Загрузка файлов**:
   - Использование ноды "Google Drive" для загрузки файлов
   - Определение папки для сохранения файлов
   - Управление версиями файлов

3. **Обмен ссылками**:
   - Генерация публичных ссылок на файлы
   - Отправка ссылок пользователям через различные каналы

#### Пример конфигурации ноды Google Drive:
```json
{
 "operation": "upload",
  "driveId": "my-drive",
  "folderId": "{{target_folder_id}}",
  "fileName": "{{document_name}}.pdf",
  "options": {
    "createSubfolder": false,
    "makePublic": true
 }
}
```

### 3. Сохранение в Nextcloud

#### Настройка интеграции с Nextcloud:
1. **Конфигурация подключения**:
   - Указание URL сервера Nextcloud
   - Настройка аутентификации (логин/пароль или API токен)
   - Определение целевой папки

2. **Работа с файлами**:
   - Загрузка файлов через WebDAV API
   - Управление правами доступа к файлам
   - Синхронизация с локальными копиями

#### Пример конфигурации ноды Nextcloud:
```json
{
  "operation": "upload",
  "serverUrl": "{{nextcloud_server_url}}",
  "username": "{{nextcloud_username}}",
  "password": "{{nextcloud_password}}",
  "filePath": "/meta-agent/{{document_name}}.pdf",
  "options": {
    "overwrite": true
  }
}
```

### 4. Отправка через Email

#### Настройка отправки Email:
1. **Конфигурация SMTP**:
   - Настройка SMTP-сервера (Gmail, Outlook, корпоративный)
   - Ввод учетных данных (логин/пароль или API ключ)
   - Настройка отправителя и получателя

2. **Формирование сообщений**:
   - Создание HTML-шаблонов писем
   - Вставка вложений (PDF, чертежи)
   - Настройка темы и приоритета писем

#### Пример конфигурации ноды Email:
```json
{
  "transport": "smtp",
  "service": "gmail",
  "credentials": {
    "user": "{{gmail_user}}",
    "password": "{{gmail_password}}"
  },
  "fromEmail": "{{from_email}}",
  "toEmail": "{{user_email}}",
  "subject": "Результаты запроса к мета-агенту",
  "body": "{{email_body}}",
  "attachments": [
    {
      "name": "{{document_name}}.pdf",
      "data": "{{pdf_data}}"
    }
  ]
}
```

### 5. Отправка через Slack

#### Настройка интеграции со Slack:
1. **Создание Slack App**:
   - Создание приложения в Slack API
   - Настройка OAuth scopes (chat:write, files:write)
   - Установка приложения в workspace

2. **Отправка сообщений**:
   - Использование ноды "Slack" для отправки сообщений
   - Отправка текстовых сообщений и файлов
   - Упоминание пользователей и каналов

#### Пример конфигурации ноды Slack:
```json
{
  "authentication": "accessToken",
  "accessToken": "{{slack_access_token}}",
  "channel": "{{slack_channel}}",
  "text": "{{response_text}}",
  "attachments": [
    {
      "title": "{{document_name}}",
      "text": "Спецификация во вложении",
      "fields": [
        {
          "title": "Статус",
          "value": "Готово",
          "short": true
        }
      ]
    }
  ]
}
```

## Управление контекстом диалога

Для обеспечения связности диалога между различными каналами ввода/вывода необходимо реализовать систему управления контекстом.

### Хранение контекста:
1. **Временное хранение**:
   - Использование Simple Memory ноды в AI Agent
   - Хранение контекста в рамках одной сессии

2. **Долговременное хранение**:
   - Использование базы данных (PostgreSQL, SQLite)
   - Сохранение истории взаимодействий с пользователями
   - Ассоциация контекста с идентификатором пользователя

### Персистентность контекста:
1. **Сохранение состояния**:
   - Автоматическое сохранение контекста после каждого сообщения
   - Загрузка контекста при начале нового диалога

2. **Управление сессиями**:
   - Определение времени жизни сессии
   - Автоматическое завершение неактивных сессий
   - Возможность принудительного сброса контекста

## Безопасность и аутентификация

### Аутентификация пользователей:
1. **Telegram**:
   - Использование User ID как идентификатора
   - Возможность настройки белого списка пользователей

2. **Web-интерфейсы**:
   - OAuth 2.0 интеграция с корпоративными системами
   - JWT токены для аутентификации
   - Сессионная аутентификация

3. **Webhook**:
   - API ключи для аутентификации запросов
   - Подпись запросов для проверки целостности

### Управление доступом:
1. **Ролевая модель**:
   - Определение ролей пользователей (инженер, менеджер, администратор)
   - Настройка прав доступа к функциям агента

2. **Ограничения по функциональности**:
   - Ограничение доступа к критическим операциям
   - Лимиты на количество запросов
   - Контроль использования ресурсов

## Мониторинг и логирование

### Логирование взаимодействий:
1. **Запись сообщений**:
   - Логирование всех входящих и исходящих сообщений
   - Сохранение метаданных (время, пользователь, канал)

2. **Анализ использования**:
   - Статистика по каналам ввода/вывода
   - Популярные типы запросов
   - Время отклика по каждому каналу

### Метрики производительности:
1. **Время обработки запросов**:
   - Измерение времени от получения запроса до отправки ответа
   - Мониторинг времени выполнения отдельных этапов

2. **Доступность сервисов**:
   - Мониторинг состояния каналов ввода/вывода
   - Уведомления о сбоях и недоступности

## Масштабируемость и отказоустойчивость

### Горизонтальное масштабирование:
1. **Распределение нагрузки**:
   - Балансировка запросов между инстансами n8n
   - Разделение каналов по разным серверам

2. **Кластеризация**:
   - Настройка кластера n8n для высокой доступности
   - Синхронизация состояния между инстансами

### Обработка ошибок:
1. **Повторные попытки**:
   - Реализация retry-логики для временных ошибок
   - Настройка экспоненциальной задержки

2. **Fallback-механизмы**:
   - Альтернативные каналы для критических уведомлений
   - Резервные способы доставки результатов

## Пример комплексного workflow для обработки запроса

1. **Получение запроса**:
   - Нода Telegram Trigger получает сообщение
   - Извлечение текста запроса и идентификатора пользователя

2. **Загрузка контекста**:
   - Нода Function загружает историю диалога из базы данных
   - Формирование полного контекста для LLM

3. **Классификация запроса**:
   - Нода AI Agent классифицирует тип запроса
   - Определение маршрута обработки

4. **Обработка запроса**:
   - Выполнение специализированного workflow в зависимости от типа
   - Генерация ответа или документа

5. **Отправка результата**:
   - Нода Telegram отправляет ответ пользователю
   - При необходимости, файлы загружаются в Google Drive и отправляются ссылки

6. **Сохранение контекста**:
   - Обновление истории диалога в базе данных
   - Подготовка к следующему запросу